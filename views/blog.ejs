<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title><%= blog.title %> | Blogify</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

  <!-- Modal styles -->
  <style>
    /* --- modal backdrop --- */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      z-index: 999;
      display: none;
      align-items: flex-end;
      justify-content: center;
    }

    /* --- sliding panel --- */
    .modal-panel {
      background: #2c3e50;
      width: 100%;
      max-width: 600px;
      height: 80vh;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      box-shadow: 0 -4px 20px rgba(0,0,0,.4);
      display: flex;
      flex-direction: column;
      transform: translateY(100%);
      transition: transform .35s ease-out;
    }

    .modal-overlay.show .modal-panel {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.2rem;
      border-bottom: 1px solid #34495e;
      flex-shrink: 0;
    }

    .modal-header h3 {
      margin: 0;
      color: #ecf0f1;
      font-size: 1.2rem;
    }

    .close-btn {
      background: none;
      border: none;
      color: #ecf0f1;
      font-size: 1.6rem;
      cursor: pointer;
    }

    .modal-body {
      flex: 1 1 auto;
      overflow-y: auto;
      padding: 1rem;
    }

    /* --- single comment card inside modal --- */
    .comment-card {
      background: #34495e;
      border-radius: 6px;
      padding: .75rem 1rem;
      margin-bottom: .75rem;
    }

    .comment-meta {
      font-size: .85rem;
      color: #95a5a6;
      margin-bottom: .25rem;
    }

    .comment-text {
      color: #ecf0f1;
      margin: 0 0 .5rem;
    }

    /* --- responsive tweaks --- */
    @media (max-width: 600px) {
      .modal-panel { height: 90vh; }
    }
  </style>
</head>

<body style="background-color:#1a2634;color:#ecf0f1;margin:0;font-family:Arial,Helvetica,sans-serif;">
<%- include('partials/header', { user }) %>

<div style="max-width:800px;margin:2rem auto;padding:2rem;background:#2c3e50;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.3)">
  <% if (success_msg) { %>
    <p style="padding:1rem;margin-bottom:1rem;background:#d4edda;color:#155724;border-radius:4px">
      <i class="fas fa-check-circle"></i> <%= success_msg %>
    </p>
  <% } %>
  <% if (error_msg) { %>
    <p style="padding:1rem;margin-bottom:1rem;background:#f8d7da;color:#721c24;border-radius:4px">
      <i class="fas fa-exclamation-circle"></i> <%= error_msg %>
    </p>
  <% } %>

  <h1 style="font-size:2rem;margin-bottom:1rem"><%= blog.title %></h1>

  <% if (blog.coverImage) { %>
    <img src="<%= blog.coverImage %>" alt="Cover" style="max-width:100%;border-radius:4px;margin-bottom:1rem;box-shadow:0 2px 8px rgba(0,0,0,.2)">
  <% } %>

  <div style="font-size:.9rem;color:#7f8c8d;margin-bottom:1rem">
    By <a href="/profile/<%= blog.createdBy._id %>" style="color:#3498db;text-decoration:none"><i class="fas fa-user"></i> <%= blog.createdBy.fullname %></a>
    <i class="fas fa-clock"></i> <%= moment(blog.createdAt).fromNow() %>
  </div>

  <div style="line-height:1.6;margin-bottom:2rem"><%= blog.body %></div>

  <% if (user) { %>
    <div style="display:flex;gap:1rem;margin-bottom:2rem;flex-wrap:wrap">
      <form action="/blog/<%= blog._id %>/like" method="POST">
        <button type="submit" style="padding:.5rem 1rem;border:none;border-radius:4px;cursor:pointer;font-size:.9rem;transition:.3s;transform:.2s"
                onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"
                style="background-color:<%= blog.likes.includes(user._id) ? '#e74c3c' : '#3498db' %>;color:#fff">
          <i class="fas <%= blog.likes.includes(user._id) ? 'fa-heart' : 'fa-heart-broken' %>"></i>
          <%= blog.likes.includes(user._id) ? 'Unlike' : 'Like' %> (<%= blog.likes.length %>)
        </button>
      </form>

      <% if (user._id.toString() === blog.createdBy._id.toString()) { %>
        <form action="/blog/<%= blog._id %>?_method=DELETE" method="POST" class="delete-form">
          <button type="submit" style="padding:.5rem 1rem;background:#e74c3c;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:.9rem;transition:.3s"
                  onmouseover="this.style.background='#c0392b'" onmouseout="this.style.background='#e74c3c'">
            <i class="fas fa-trash"></i> Delete Blog
          </button>
        </form>
      <% } %>

      <!-- View Comments trigger -->
      <button id="openComments" type="button" style="padding:.5rem 1rem;background:#3498db;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:.9rem">
        <i class="fas fa-comments"></i> View Comments (<%= comments.length %>)
      </button>
    </div>
  <% } %>

  <!-- Comment modal -->
  <div class="modal-overlay" id="commentsModal">
    <div class="modal-panel">
      <div class="modal-header">
        <h3><i class="fas fa-comments"></i> Comments</h3>
        <button class="close-btn" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <% comments.forEach(c => { %>
          <div class="comment-card">
            <div class="comment-meta">
              <strong><%= c.createdBy.fullname %></strong> &bull; <%= moment(c.createdAt).fromNow() %>
            </div>
            <div class="comment-text"><%= c.content %></div>
            <% if (user && user._id.toString() === c.createdBy._id.toString()) { %>
              <form action="/comment/<%= c._id %>?_method=DELETE&blogId=<%= blog._id %>" method="POST" class="delete-form" style="margin-top:.5rem">
                <button type="submit" style="padding:.4rem .7rem;background:#e74c3c;color:#fff;border:none;border-radius:4px;font-size:.8rem">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </form>
            <% } %>
            <form action="/comment/<%= c._id %>/like" method="POST" style="display:inline-block;margin-top:.5rem">
              <button type="submit" style="padding:.4rem .7rem;background:<%= c.likes.includes(user?._id) ? '#e74c3c' : '#3498db' %>;color:#fff;border:none;border-radius:4px;font-size:.8rem">
                <i class="fas <%= c.likes.includes(user?._id) ? 'fa-thumbs-up' : 'fa-thumbs-down' %>"></i>
                <%= c.likes.includes(user?._id) ? 'Unlike' : 'Like' %> (<%= c.likes.length %>)
              </button>
            </form>
          </div>
        <% }) %>
      </div>
    </div>
  </div>

  <!-- Comment form (still below the blog body) -->
  <% if (user) { %>
    <div style="margin-top:2rem">
      <form action="/comment/<%= blog._id %>" method="POST">
        <textarea name="content" required placeholder="Add a commentâ€¦" style="width:100%;padding:.75rem;border:1px solid #34495e;border-radius:4px;background:#34495e;color:#ecf0f1;resize:vertical;min-height:80px"></textarea>
        <button type="submit" style="margin-top:.5rem;padding:.75rem 1rem;background:#3498db;color:#fff;border:none;border-radius:4px;cursor:pointer">
          <i class="fas fa-comment"></i> Post Comment
        </button>
      </form>
    </div>
  <% } %>
</div>

<!-- Simple JS for the modal -->
<script>
  (() => {
    const overlay = document.getElementById('commentsModal');
    const openBtn = document.getElementById('openComments');
    const closeBtn = overlay.querySelector('.close-btn');

    if (!overlay || !openBtn) return; // safety if no user

    openBtn.addEventListener('click', () => {
      overlay.style.display = 'flex';
      // trigger animation
      requestAnimationFrame(() => overlay.classList.add('show'));
    });

    const close = () => {
      overlay.classList.remove('show');
      overlay.addEventListener('transitionend', () => overlay.style.display = 'none', { once: true });
    };
    closeBtn.addEventListener('click', close);
    overlay.addEventListener('click', e => { if (e.target === overlay) close(); });

    // delete confirmations
    document.querySelectorAll('.delete-form').forEach(f =>
      f.addEventListener('submit', e => { if (!confirm('Delete this item?')) e.preventDefault(); })
    );
  })();
</script>
</body>
</html>
