<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= blog.title %> | Blogify</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    /* --- Modal styles (bottom-up scrollable) --- */
    .comments-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.6);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 1000;
    }
    .comments-modal.show { display: flex; }

    .comments-drawer {
      width: 100%;
      height: 80vh;
      background: #1e1e1e;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      transform: translateY(100%);
      transition: transform .35s ease;
      display: flex;
      flex-direction: column;
    }
    .comments-modal.show .comments-drawer { transform: translateY(0); }

    .comments-header {
      padding: 1rem;
      border-bottom: 1px solid #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .comments-header h3 { margin: 0; color:#ecf0f1; }
    .comments-body {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .single-comment {
      background: #2a2a2a;
      border-radius: 6px;
      padding: .75rem;
      margin-bottom: .75rem;
      display: flex;
      gap: .75rem;
    }
    .single-comment img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
    }
    .comment-meta {
      font-size: .8rem;
      color: #aaa;
    }
    .close-btn {
      background: none;
      border: none;
      color: #ecf0f1;
      font-size: 1.4rem;
      cursor: pointer;
    }

    /* --- (keep your existing mobile tweaks) --- */
    @media (max-width: 768px) {
      div[style*='max-width: 800px'] { margin: 1rem; padding: 1rem; }
      h1 { font-size: 1.5rem; }
      div[style*='display: flex; gap: 1rem'] { flex-direction: column; gap: 0.5rem; }
    }
  </style>
</head>

<body style="background-color: #1a2634; color: #ecf0f1; margin: 0; font-family: 'Arial', sans-serif;">
  <%- include('partials/header', { user }) %>

  <div style="max-width: 800px; margin: 2rem auto; padding: 2rem; background-color: #2c3e50; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,.3);">
    <% if (success_msg) { %>
      <p style="padding:1rem; margin-bottom:1rem; background:#d4edda; color:#155724; border-radius:4px;">
        <i class="fas fa-check-circle"></i> <%= success_msg %>
      </p>
    <% } %>
    <% if (error_msg) { %>
      <p style="padding:1rem; margin-bottom:1rem; background:#f8d7da; color:#721c24; border-radius:4px;">
        <i class="fas fa-exclamation-circle"></i> <%= error_msg %>
      </p>
    <% } %>

    <h1 style="font-size:2rem; color:#ecf0f1; margin-bottom:1rem;"><%= blog.title %></h1>

    <% if (blog.coverImage) { %>
      <img src="<%= blog.coverImage %>" alt="Cover" style="max-width:100%; border-radius:4px; margin-bottom:1rem; box-shadow:0 2px 8px rgba(0,0,0,.2);">
    <% } %>

    <div style="font-size:.9rem; color:#7f8c8d; margin-bottom:1rem;">
      By <a href="/profile/<%= blog.createdBy._id %>" style="color:#3498db; text-decoration:none;"
            onmouseover="this.style.textDecoration='underline'"
            onmouseout="this.style.textDecoration='none'"><i class="fas fa-user"></i> <%= blog.createdBy.fullname %></a>
      <i class="fas fa-clock"></i> <%= moment(blog.createdAt).fromNow() %>
    </div>

    <div style="color:#ecf0f1; margin-bottom:2rem; line-height:1.6;"><p><%= blog.body %></p></div>

    <div style="display:flex; gap:1rem; margin-bottom:2rem; flex-wrap:wrap;">
      <% if (user) { %>
        <form action="/blog/<%= blog._id %>/like" method="POST">
          <button type="submit" style="padding:.5rem 1rem; border:none; border-radius:4px; cursor:pointer;
            background-color:<%= blog.likes.includes(user._id) ? '#e74c3c' : '#3498db' %>; color:#fff;">
            <i class="fas <%= blog.likes.includes(user._id) ? 'fa-heart' : 'fa-heart-broken' %>"></i>
            <%= blog.likes.includes(user._id) ? 'Unlike' : 'Like' %> (<%= blog.likes.length %>)
          </button>
        </form>

        <% if (user._id.toString() === blog.createdBy._id.toString()) { %>
          <form action="/blog/<%= blog._id %>?_method=DELETE" method="POST" class="delete-form">
            <button type="submit" style="padding:.5rem 1rem; border:none; border-radius:4px; cursor:pointer; background:#e74c3c; color:#fff;">
              <i class="fas fa-trash"></i> Delete
            </button>
          </form>
        <% } %>
      <% } %>

      <!-- Button opens the modal -->
      <button type="button" onclick="openComments()" style="padding:.5rem 1rem; border:none; border-radius:4px; cursor:pointer; background:#3498db; color:#fff;">
        <i class="fas fa-comments"></i> View Comments (<%= comments.length %>)
      </button>
    </div>

    <!-- ========== MODAL / DRAWER ========== -->
    <div id="commentsModal" class="comments-modal" onclick="if(event.target===this) closeComments()">
      <div class="comments-drawer">
        <div class="comments-header">
          <h3><i class="fas fa-comments"></i> Comments</h3>
          <button class="close-btn" onclick="closeComments()">&times;</button>
        </div>

        <div class="comments-body">
          <% comments.forEach(comment => { %>
            <div class="single-comment">
              <img src="<%= comment.createdBy.profileImageURL %>" alt="avatar">
              <div>
                <strong><%= comment.createdBy.fullname %></strong><br>
                <%= comment.content %>
                <div class="comment-meta">
                  <i class="fas fa-clock"></i> <%= moment(comment.createdAt).fromNow() %>
                </div>

                <% if (user && user._id.toString() === comment.createdBy._id.toString()) { %>
                  <form action="/comment/<%= comment._id %>?_method=DELETE&blogId=<%= blog._id %>" method="POST"
                        class="delete-form" style="display:inline-block; margin-top:.4rem;">
                    <button type="submit" style="padding:.3rem .6rem; background:#e74c3c; border:none; border-radius:4px; color:#fff; cursor:pointer;">
                      <i class="fas fa-trash"></i>
                    </button>
                  </form>
                <% } %>
              </div>
            </div>
          <% }) %>

          <% if (user) { %>
            <form action="/comment/<%= blog._id %>" method="POST" style="margin-top:1rem;">
              <textarea name="content" required placeholder="Write a commentâ€¦" rows="3"
                        style="width:100%; padding:.6rem; border-radius:4px; background:#2c3e50; color:#ecf0f1; border:1px solid #34495e;"></textarea>
              <button type="submit" style="margin-top:.5rem; padding:.5rem 1rem; background:#3498db; border:none; border-radius:4px; color:#fff; cursor:pointer;">
                Post Comment
              </button>
            </form>
          <% } %>
        </div>
      </div>
    </div>
    <!-- ========== /MODAL ========== -->
  </div>

  <script>
    /* --- modal helpers --- */
    function openComments() {
      document.getElementById('commentsModal').classList.add('show');
      document.body.style.overflow = 'hidden';
    }
    function closeComments() {
      document.getElementById('commentsModal').classList.remove('show');
      document.body.style.overflow = '';
    }

    /* --- existing delete confirm --- */
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.delete-form').forEach(form => {
        form.addEventListener('submit', (e) => {
          if (!confirm('Are you sure you want to delete this?')) e.preventDefault();
        });
      });
    });
  </script>
</body>
</html>
